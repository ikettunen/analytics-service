# Analytics Service deployment workflow for EC2 self-hosted runner
# Deploys Python Flask service to EC2 and restarts with PM2

name: Deploy Analytics Service to EC2

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Verify Python version
      run: |
        python --version
        pip --version
    
    - name: Install dependencies
      run: pip install -r requirements.txt
    
    - name: Deploy to EC2
      run: |
        # Backup current version
        if [ -d ~/analytics-service ]; then
          cp -r ~/analytics-service ~/analytics-service.backup
        fi
        
        # Copy new files (excluding .git and __pycache__)
        rsync -av --exclude='.git' --exclude='__pycache__' --exclude='*.pyc' ./ ~/analytics-service/
        
        # Setup production environment
        cd ~/analytics-service
        cp .env.production .env
        
        # Add deployment timestamp (cross-platform compatible)
        {
          echo ""
          echo "# Last deployed: $(date -u +'%Y-%m-%d %H:%M:%S UTC') via GitHub Actions"
          echo "# Deployment ID: $GITHUB_RUN_ID"
          echo "# Commit SHA: $GITHUB_SHA"
          echo "# Commit Message: $(git log -1 --pretty=format:'%s' $GITHUB_SHA 2>/dev/null || echo 'No commit message available')"
        } >> .env
        
        # Install dependencies in target directory
        pip install -r requirements.txt
        
        echo "Deployed to ~/analytics-service"
    
    - name: Restart service with PM2
      run: |
        cd ~/analytics-service
        pm2 restart analytics-service || pm2 start app.py --name analytics-service --interpreter python3
        pm2 save
    
    - name: Deployment Summary
      run: |
        echo "âœ… Analytics Service deployed successfully!"
        echo "ğŸŒ Service URL: http://51.20.164.143:5002"
        echo "ğŸ“ Deployed to: ~/analytics-service"
        echo ""
        echo "PM2 Status:"
        pm2 list | grep analytics-service
